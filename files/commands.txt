###Import data and metadata- create artifact###
#
mkdir working_dir
#
qiime tools import \
  --type 'SampleData[SequencesWithQuality]' \
  --input-path /home/participant/Desktop/qiime2/hands_on/manifesto.txt \
  --output-path /home/participant/Desktop/qiime2/hands_on/working_dir/single-end-demux.qza \
  --source-format SingleEndFastqManifestPhred33
#
cd working_dir
#
###Create visualization file###
#
qiime demux summarize \
  --i-data single-end-demux.qza \
  --o-visualization single-end-demux.qzv
#
###Look at vislualization file###
#
qiime tools view single-end-demux.qzv
#
###Quality filtering and freature/ASV picking with DADA2###
#
qiime dada2 denoise-single \
--i-demultiplexed-seqs single-end-demux.qza \
--p-trunc-len 0 \
--p-trunc-q 19 \
--output-dir DADA2
#
###Create visualization file###
#
qiime feature-table summarize \
--i-table DADA2/table.qza \
--o-visualization DADA2/table-dada2.qzv \
--m-sample-metadata-file /home/participant/Desktop/qiime2/hands_on/mapping_file.tsv
#
###Look at vislualization file###
#
qiime tools view DADA2/table-dada2.qzv
#
###Export teble with features/ sample###
#
qiime tools export table-dada2.qza --output-dir exported_table
cd exported_table
biom convert -i feature-table.biom -o feature-table.txt --to-tsv
#
###Generate alignement of features for tree creation###
#
qiime alignment mafft \
--i-sequences DADA2/representative_sequences.qza \
--o-alignment aligned-rep-seqs-dada2.qza
#
###Filter alignment###
#
qiime alignment mask \
--i-alignment aligned-rep-seqs-dada2.qza \
--o-masked-alignment masked-aligned-rep-seqs-dada2.qza
#
###Build tree###
#
qiime phylogeny fasttree \
--i-alignment masked-aligned-rep-seqs-dada2.qza \
--o-tree unrooted-tree.qza
#
###Root tree###
#
qiime phylogeny midpoint-root \
--i-tree unrooted-tree.qza \
--o-rooted-tree rooted-tree.qza
#
###Calculate diversity metrics###
#
qiime diversity core-metrics-phylogenetic \
 --i-phylogeny rooted-tree.qza \
 --i-table DADA2/table.qza \
 --p-sampling-depth 5474 \
 --m-metadata-file /home/participant/Desktop/qiime2/hands_on/mapping_file.tsv \
 --output-dir core-metrics-results
#
###Look at vislualization files###
qiime tools view core-metrics-results/unweighted_unifrac_emperor.qzv
#
###Check for significance of groups###
#
qiime diversity beta-group-significance \
--i-distance-matrix unweighted_unifrac_distance_matrix.qza \
--m-metadata-file /home/participant/Desktop/qiime2/hands_on/mapping_file.tsv \
--m-metadata-column AntibioticUsage \
--o-visualization unweighted_unifrac_AntibioticUsage-significance.qzv
#
###Look at vislualization files###
#
qiime tools view unweighted_unifrac_AntibioticUsage-significance.qzv
#
###Test for significance for alpha diveristy###
#
qiime diversity alpha-group-significance \
  --i-alpha-diversity observed_otus_vector.qza \
  --m-metadata-file ~/Documents/files_hands_on/mapping_file.tsv \
  --o-visualization observed_otus_vector-group-significance.qzv
#
###Look at vislualization files###
#
qiime tools view observed_otus_vector-group-significance.qzv
#
###Perform taxonomic classification###
#
qiime feature-classifier classify-sklearn \
  --i-classifier /home/participant/Desktop/qiime2/hands_on/gg-13-8-99-nb-classifier.qza \
  --i-reads DADA2/representative_sequences.qza \
  --o-classification taxonomy.qza
#
###create visualization file###
#
qiime metadata tabulate \
  --m-input-file taxonomy.qza \
  --o-visualization taxonomy.qzv
#
###Create vislualization file-bar plots###
#
qiime taxa barplot \
  --i-table DADA2/table.qza \
  --i-taxonomy taxonomy.qza \
  --m-metadata-file /home/participant/Desktop/qiime2/hands_on/mapping_file.tsv \
  --o-visualization taxa-bar-plots.qzv
#
qiime tools view taxa-bar-plots.qzv
#
###Calculate differential abundances###
#
qiime taxa collapse \
  --i-table DADA2/table.qza \
  --i-taxonomy taxonomy.qza \
  --p-level 6 \
  --o-collapsed-table table-dada2-l6.qza
#
qiime composition add-pseudocount \
  --i-table table-dada2-l6.qza \
  --o-composition-table comp-table-dada2-l6.qza
#
qiime composition ancom \
  --i-table comp-table-dada2-l6.qza \
  --m-metadata-file /home/participant/Desktop/qiime2/hands_on/mapping_file.tsv \
  --m-metadata-column AntibioticUsage \
  --o-visualization l6-ancom-AntibioticUsage.qzv
#
###visualization###
#
qiime tools view l6-ancom-AntibioticUsage.qzv
